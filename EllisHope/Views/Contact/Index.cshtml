@model EllisHope.Models.ViewModels.ContactFormViewModel
@inject IConfiguration Configuration
@{
    ViewBag.Title = "Contact";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var foundation = Configuration.GetSection("Foundation");
    var recaptchaSiteKey = ViewBag.RecaptchaSiteKey as string;

    // Email obfuscation - split into parts for bot protection
    var foundationEmail = foundation["Email"] ?? "";
    var emailUser = "";
    var emailDomain = "";
    if (!string.IsNullOrEmpty(foundationEmail))
    {
        var emailParts = foundationEmail.Split('@');
        emailUser = emailParts.Length > 0 ? emailParts[0] : "";
        emailDomain = emailParts.Length > 1 ? emailParts[1] : "";
    }
}

<main>

    <!-- page-title-area start -->
    <div class="page-title-area">
        <div class="breadcrumb-wrapper" data-background="@Content.Image("Contact", "HeaderBanner")">
            <img class="shape-1" src="~/assets/img/shape/shape-81.png" alt="shape">
            <img class="shape-2" src="~/assets/img/shape/shape-82.png" alt="shape">
            <div class="container">
                <div class="breadcrumb-content text-center">
                    <h2 class="breadcrumb-title">Contact</h2>
                    <ul class="breadcrumb-menu">
                        <li>
                            <a href="/">Home</a>
                        </li>
                        <li>
                            <a href="#">Contact</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- page-title-area end -->

    <!-- ht-contact-section-info start -->
    <div class="ht-contact-section-info pt-140 pb-95 pt-lg-100 pb-lg-55">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-4 col-md-6">
                    <div class="info-box2 d-xl-flex">
                        <div class="icon">
                            <i class="bi bi-geo-alt"></i>
                        </div>
                        <div class="info-content">
                            <h3 class="info-title">@Content.Text("Contact", "AddressLabel")</h3>
                            <p>
                                @foundation["Address"]<br>
                                @foundation["City"], @foundation["State"] @foundation["ZipCode"]
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6">
                    <div class="info-box2 d-xl-flex border-styles">
                        <div class="icon">
                            <i class="bi bi-envelope"></i>
                        </div>
                        <div class="info-content">
                            <h3 class="info-title">@Content.Text("Contact", "EmailLabel")</h3>
                            <p>
                                <a href="#" class="obfuscated-email"
                                   data-user="@emailUser"
                                   data-domain="@emailDomain">@(emailUser)[at]@(emailDomain)</a>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6">
                    <div class="info-box2 d-xl-flex">
                        <div class="icon">
                            <i class="bi bi-telephone"></i>
                        </div>
                        <div class="info-content">
                            <h3 class="info-title">@Content.Text("Contact", "PhoneLabel")</h3>
                            <p>
                                <a href="tel:@foundation["Phone"]">@foundation["Phone"]</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ht-contact-section-info end -->

    <!-- ht-contact-section start -->
    <section class="contact-section mb-180 mb-lg-60" data-bg-color="#FDF3F0">
        <div class="container-fluid px-0">
            <div class="row gx-lg-0 align-items-center">
                <div class="col-lg-6">
                    <div class="contact-map">
                        <iframe src="@foundation["MapEmbedUrl"]"
                                width="600" height="450" style="border: 0;" allowfullscreen="" loading="lazy"
                                referrerpolicy="no-referrer-when-downgrade">
                        </iframe>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="contact-form-wrapper-5">
                        <div class="title mb-30">
                            <h2 class="contact-title">@Content.Text("Contact", "FormTitle")</h2>
                            <p>
                                @Content.Text("Contact", "FormSubtitle")
                            </p>
                        </div>

                        @* Success Message *@
                        @if (!string.IsNullOrEmpty(Model?.SuccessMessage))
                        {
                            <div class="alert alert-success d-flex align-items-center mb-4" role="alert">
                                <i class="bi bi-check-circle-fill me-2 fs-5"></i>
                                <div>@Model.SuccessMessage</div>
                            </div>
                        }
                        else
                        {
                            @* Error Message *@
                            @if (!string.IsNullOrEmpty(Model?.ErrorMessage))
                            {
                                <div class="alert alert-danger d-flex align-items-center mb-4" role="alert">
                                    <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                                    <div>@Model.ErrorMessage</div>
                                </div>
                            }

                            @* Validation Summary *@
                            @if (!ViewData.ModelState.IsValid)
                            {
                                <div class="alert alert-warning mb-4" role="alert">
                                    <div asp-validation-summary="All" class="text-danger"></div>
                                </div>
                            }

                            <form class="contact-form form-4" asp-action="Index" asp-controller="Contact" method="post" id="contactForm">
                                @Html.AntiForgeryToken()

                                @* Honeypot field - hidden from real users, bots will fill it *@
                                <div style="position: absolute; left: -5000px;" aria-hidden="true">
                                    <input type="text" name="Website" tabindex="-1" autocomplete="off" asp-for="Website">
                                </div>

                                <div class="input-wrapper">
                                    <input type="text" asp-for="Name" placeholder="Name" class="form-control">
                                    <span asp-validation-for="Name" class="text-danger small"></span>
                                </div>
                                <div class="input-wrapper">
                                    <input type="email" asp-for="Email" placeholder="Email" class="form-control">
                                    <span asp-validation-for="Email" class="text-danger small"></span>
                                </div>
                                <div class="col-12">
                                    <div class="input-wrapper message">
                                        <textarea asp-for="Message" placeholder="Your Message" class="form-control"></textarea>
                                        <span asp-validation-for="Message" class="text-danger small"></span>
                                    </div>
                                </div>

                                @* Hidden field for reCAPTCHA token *@
                                <input type="hidden" asp-for="RecaptchaToken" id="recaptchaToken">

                                <div class="col-12">
                                    <button type="submit" class="ht-btn w-auto" id="submitBtn">
                                        <span class="btn-text">Send message</span>
                                        <span class="btn-loading d-none">
                                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                            Sending...
                                        </span>
                                    </button>
                                </div>

                                @if (!string.IsNullOrEmpty(recaptchaSiteKey))
                                {
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            This site is protected by reCAPTCHA and the Google
                                            <a href="https://policies.google.com/privacy" target="_blank" rel="noopener">Privacy Policy</a> and
                                            <a href="https://policies.google.com/terms" target="_blank" rel="noopener">Terms of Service</a> apply.
                                        </small>
                                    </div>
                                }
                            </form>
                        }
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- ht-contact-section end -->

    <!-- newsletter-section start -->
    <div class="newsletter-section position-relative z-1">
        <img class="shape-1 position-absolute ml-100 d-none d-lg-inline-block"
             src="~/assets/img/shape/shape-8.png" alt="shape">
        <div class="container">
            @if (TempData["NewsletterSuccess"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i>@TempData["NewsletterSuccess"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }
            @if (TempData["NewsletterError"] != null)
            {
                <div class="alert alert-warning alert-dismissible fade show mb-3" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>@TempData["NewsletterError"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }
            <div class="row align-items-center newsletter-border pt-50">
                <div class="col-lg-6">
                    <div class="title-one text-lg-start text-center">
                        <h2 class="title">@Content.Text("Contact", "NewsletterTitle")</h2>
                    </div>
                </div>
                <div class="col-lg-6">
                    <form asp-controller="Newsletter" asp-action="Subscribe" method="post" class="subscribe-form sub-form-2 text-lg-end">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="returnUrl" value="@Context.Request.Path" />
                        <input type="email" name="email" placeholder="Enter Your Email" required>
                        <button type="submit">Subscribe</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- newsletter-section end -->

</main>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    @if (!string.IsNullOrEmpty(recaptchaSiteKey))
    {
        <script src="https://www.google.com/recaptcha/api.js?render=@recaptchaSiteKey"></script>
        <script>
            document.getElementById('contactForm')?.addEventListener('submit', function(e) {
                e.preventDefault();

                const form = this;
                const submitBtn = document.getElementById('submitBtn');
                const btnText = submitBtn.querySelector('.btn-text');
                const btnLoading = submitBtn.querySelector('.btn-loading');

                // Show loading state
                btnText.classList.add('d-none');
                btnLoading.classList.remove('d-none');
                submitBtn.disabled = true;

                // Execute reCAPTCHA
                grecaptcha.ready(function() {
                    grecaptcha.execute('@recaptchaSiteKey', { action: 'contact_form' }).then(function(token) {
                        // Set the token in the hidden field
                        document.getElementById('recaptchaToken').value = token;
                        // Submit the form
                        form.submit();
                    }).catch(function(error) {
                        console.error('reCAPTCHA error:', error);
                        // Reset button state
                        btnText.classList.remove('d-none');
                        btnLoading.classList.add('d-none');
                        submitBtn.disabled = false;
                        alert('Security verification failed. Please try again.');
                    });
                });
            });
        </script>
    }
    else
    {
        <script>
            // Development mode without reCAPTCHA - just show loading state
            document.getElementById('contactForm')?.addEventListener('submit', function(e) {
                const submitBtn = document.getElementById('submitBtn');
                const btnText = submitBtn.querySelector('.btn-text');
                const btnLoading = submitBtn.querySelector('.btn-loading');

                btnText.classList.add('d-none');
                btnLoading.classList.remove('d-none');
                submitBtn.disabled = true;

                // Set a dummy token for development
                document.getElementById('recaptchaToken').value = 'development-mode-token';
            });
        </script>
    }
}
