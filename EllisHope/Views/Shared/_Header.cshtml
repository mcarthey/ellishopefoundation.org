@using Microsoft.AspNetCore.Identity
@using EllisHope.Models.Domain
@inject IConfiguration Configuration
@inject UserManager<ApplicationUser> UserManager
@inject EllisHope.Services.ISiteSettingsService SiteSettings
@{
    var foundation = Configuration.GetSection("Foundation");
    var defaultDonateUrl = await SiteSettings.GetDefaultDonationUrlAsync() ?? "/contact";
    var givebutterAccountId = await SiteSettings.GetGivebutterAccountIdAsync();
    var givebutterCampaignCode = await SiteSettings.GetCampaignCodeAsync();
    string? profilePictureUrl = null;
    if (User.Identity?.IsAuthenticated == true)
    {
        var user = await UserManager.GetUserAsync(User);
        profilePictureUrl = user?.ProfilePictureUrl;
    }

    // Email obfuscation - split into parts for bot protection
    var foundationEmail = foundation["Email"] ?? "";
    var emailUser = "";
    var emailDomain = "";
    if (!string.IsNullOrEmpty(foundationEmail))
    {
        var emailParts = foundationEmail.Split('@');
        emailUser = emailParts.Length > 0 ? emailParts[0] : "";
        emailDomain = emailParts.Length > 1 ? emailParts[1] : "";
    }
}

<header class="theme-main-menu theme-menu-two">
    <div class="main-header-area pt-25 pb-15">
        <div class="container-fluid">
            <div class="row align-items-center justify-content-between">
                <div class="col-md-auto col-6 d-flex align-items-center justify-content-start">
                    <div class="logo-area">
                        <a class="logo" href="/home/">
                            <span class="logo-bg"></span>
                            <img src="~/assets/img/logo/ellis-hope-logo.svg" alt="Header-logo" class="logo-img" />
                        </a>
                        <a class="sticky-logo" href="/home/">
                            <span class="logo-bg"></span>
                            <img src="~/assets/img/logo/ellis-hope-logo.svg" alt="Header-logo" class="logo-img" />
                        </a>
                    </div>
                    <div class="main-menu d-none d-lg-inline-block pl-90">
                        <nav id="mobile-menu">
                            <ul class="menu-list">
                                <li>
                                    <a href="#">About Us</a>
                                    <ul class="sub-menu">
                                        <li><a href="/about">Who We Are</a></li>
                                        <li><a href="/contact">Contact</a></li>
                                    </ul>
                                </li>

                                <li>
                                    <a href="#">What We Do</a>
                                    <ul class="sub-menu">
                                        <li><a href="/services">Services</a></li>
                                        <li><a href="/causes">Causes</a></li>
                                    </ul>
                                </li>

                                <li>
                                    <a href="#">Get Involved</a>
                                    <ul class="sub-menu">
                                        <li><a href="/events">Events</a></li>
                                        <li><a href="/team">Volunteers</a></li>
                                    </ul>
                                </li>

                                <li>
                                    <a href="#">Resources</a>
                                    <ul class="sub-menu">
                                        <li><a href="/blog">Blog</a></li>
                                        <li><a href="/faq">FAQ</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </nav>

                    </div>
                </div>

                <div class="col-md-auto col-6">
                    <div class="right-nav d-flex align-items-center justify-content-end">
                        <div class="quote-btn d-lg-inline-block d-none">
                            <a href="@defaultDonateUrl" target="_blank" class="ht-btn bs-btn"
                               data-gb-account="@givebutterAccountId" data-gb-campaign="@givebutterCampaignCode">Donate Now</a>
                        </div>
                        
                        <!-- Account Menu -->
                        @if (User.Identity?.IsAuthenticated == true)
                        {
                            <div class="account-menu ms-3 d-lg-inline-block d-none">
                                @if (!string.IsNullOrEmpty(profilePictureUrl))
                                {
                                    <img src="@profilePictureUrl" alt="Profile" id="publicAccountMenuToggle"
                                         class="account-avatar-img" title="@User.Identity?.Name" />
                                }
                                else
                                {
                                    <div class="account-avatar" id="publicAccountMenuToggle" title="@User.Identity?.Name">
                                        @{
                                            var initial = User.Identity?.Name?.Substring(0, 1).ToUpper() ?? "?";
                                        }
                                        @initial
                                    </div>
                                }
                                <div class="account-dropdown" id="publicAccountDropdown">
                                    <div class="account-dropdown-header">
                                        <div class="fw-bold">@User.Identity?.Name</div>
                                        <small class="text-muted">
                                            @if (User.IsInRole("Admin"))
                                            {
                                                <span class="badge bg-danger">Admin</span>
                                            }
                                            else if (User.IsInRole("BoardMember"))
                                            {
                                                <span class="badge bg-primary">Board Member</span>
                                            }
                                            else if (User.IsInRole("Sponsor"))
                                            {
                                                <span class="badge bg-success">Sponsor</span>
                                            }
                                            else if (User.IsInRole("Client"))
                                            {
                                                <span class="badge bg-info">Client</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Member</span>
                                            }
                                        </small>
                                    </div>
                                    @if (User.IsInRole("Admin"))
                                    {
                                        <a href="/Admin/Dashboard" class="account-dropdown-item">
                                            <i class="bi bi-speedometer2"></i> Admin Dashboard
                                        </a>
                                        <div class="account-dropdown-divider"></div>
                                    }
                                    @if (User.IsInRole("BoardMember"))
                                    {
                                        <a href="/Admin/BoardMember/Dashboard" class="account-dropdown-item">
                                            <i class="bi bi-briefcase-fill"></i> Board Portal
                                        </a>
                                        <div class="account-dropdown-divider"></div>
                                    }
                                    @if (User.IsInRole("Sponsor"))
                                    {
                                        <a href="/Admin/Sponsor/Dashboard" class="account-dropdown-item">
                                            <i class="bi bi-heart-fill"></i> Sponsor Portal
                                        </a>
                                        <div class="account-dropdown-divider"></div>
                                    }
                                    @if (User.IsInRole("Client"))
                                    {
                                        <a href="/Admin/Client/Dashboard" class="account-dropdown-item">
                                            <i class="bi bi-person-badge"></i> Client Portal
                                        </a>
                                        <div class="account-dropdown-divider"></div>
                                    }
                                    @if (User.IsInRole("Member"))
                                    {
                                        <a href="/Admin/Member/Dashboard" class="account-dropdown-item">
                                            <i class="bi bi-person-circle"></i> Member Portal
                                        </a>
                                        <div class="account-dropdown-divider"></div>
                                    }
                                    <a href="/Admin/Profile" class="account-dropdown-item">
                                        <i class="bi bi-person-circle"></i> My Profile
                                    </a>
                                    <a href="/Admin/Profile/Edit" class="account-dropdown-item">
                                        <i class="bi bi-pencil-square"></i> Edit Profile
                                    </a>
                                    <a href="/Admin/Profile/ChangePassword" class="account-dropdown-item">
                                        <i class="bi bi-key"></i> Change Password
                                    </a>
                                    <div class="account-dropdown-divider"></div>
                                    <form action="/Admin/Account/Logout" method="post" class="m-0" asp-antiforgery="true">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="account-dropdown-item border-0 bg-transparent text-start w-100">
                                            <i class="bi bi-box-arrow-right"></i> Sign Out
                                        </button>
                                    </form>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="sign-in-link ms-3 d-lg-inline-block d-none">
                                <a href="/Admin/Account/Login" class="sign-in-btn" title="Sign In">
                                    <i class="bi bi-person-circle"></i>
                                </a>
                            </div>
                        }
                        
                        <div class="hamburger-menu d-lg-none d-inline-flex">
                            <div class="open-sidebar">
                                <div class="bar-wrap">
                                    <div class="bar-1"></div>
                                    <div class="bar-2"></div>
                                    <div class="bar-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</header>

<!-- header-area end -->
<!-- slide-bar start -->
<div class="ht-menu-wrapper">
    <div class="ht-menu-area">
        <button class="ht-menu-toggle">
            <i class="bi bi-x-lg"></i>
        </button>
        <div class="mobile-logo">
            <a href="/home/">
                <img src="~/assets/img/logo/header-logo-2.svg" alt="logo">
            </a>
        </div>
        <div class="mobile-menu-wrapper d-lg-none d-inline-block">
            <div class="mobile-menu"></div>
        </div>
        
        <!-- Mobile Account Menu -->
        @if (User.Identity?.IsAuthenticated == true)
        {
            <div class="offset-widget mb-30">
                <div class="info-widget">
                    <div class="d-flex align-items-center mb-20">
                        @if (!string.IsNullOrEmpty(profilePictureUrl))
                        {
                            <img src="@profilePictureUrl" alt="Profile"
                                 class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;" />
                        }
                        else
                        {
                            <i class="bi bi-person-circle me-2" style="font-size: 1.5rem;"></i>
                        }
                        <h4 class="offset-title mb-0">@User.Identity?.Name</h4>
                    </div>
                    <div class="mobile-account-links">
                        @if (User.IsInRole("Admin"))
                        {
                            <a href="/Admin/Dashboard" class="d-block py-2">
                                <i class="bi bi-speedometer2"></i> Admin Dashboard
                            </a>
                        }
                        @if (User.IsInRole("BoardMember"))
                        {
                            <a href="/Admin/BoardMember/Dashboard" class="d-block py-2">
                                <i class="bi bi-briefcase-fill"></i> Board Portal
                            </a>
                        }
                        @if (User.IsInRole("Sponsor"))
                        {
                            <a href="/Admin/Sponsor/Dashboard" class="d-block py-2">
                                <i class="bi bi-heart-fill"></i> Sponsor Portal
                            </a>
                        }
                        @if (User.IsInRole("Client"))
                        {
                            <a href="/Admin/Client/Dashboard" class="d-block py-2">
                                <i class="bi bi-person-badge"></i> Client Portal
                            </a>
                        }
                        @if (User.IsInRole("Member"))
                        {
                            <a href="/Admin/Member/Dashboard" class="d-block py-2">
                                <i class="bi bi-person-circle"></i> Member Portal
                            </a>
                        }
                        <a href="/Admin/Profile" class="d-block py-2">
                            <i class="bi bi-person-circle"></i> My Profile
                        </a>
                        <a href="/Admin/Profile/Edit" class="d-block py-2">
                            <i class="bi bi-pencil-square"></i> Edit Profile
                        </a>
                        <a href="/Admin/Profile/ChangePassword" class="d-block py-2">
                            <i class="bi bi-key"></i> Change Password
                        </a>
                        <form action="/Admin/Account/Logout" method="post" class="mt-2" asp-antiforgery="true">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                                <i class="bi bi-box-arrow-right"></i> Sign Out
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="login-btn text-center mb-30">
                <a class="ht-btn style-5" href="/Admin/Account/Login">
                    <i class="bi bi-box-arrow-in-right"></i> Sign In
                </a>
            </div>
        }
        
        <div class="offset-widget mb-40">
            <div class="info-widget">
                <h4 class="offset-title mb-20">About Us</h4>
                <p class="mb-30">
                    @foundation["Description"]
                </p>
            </div>
        </div>
        <div class="offset-widget mb-30 pr-10">
            <div class="info-widget info-widget2">
                <h4 class="offset-title mb-20">Contact Info</h4>
                <p>
                    <i class="fal fa-address-book"></i>
                    @foundation["Address"], @foundation["City"], @foundation["State"] @foundation["ZipCode"]
                </p>
                <p>
                    <i class="fal fa-phone"></i>
                    @foundation["Phone"]
                </p>
                <p>
                    <i class="fal fa-envelope-open"></i>
                    <a href="#" class="obfuscated-email"
                       data-user="@emailUser"
                       data-domain="@emailDomain">@(emailUser)[at]@(emailDomain)</a>
                </p>
            </div>
        </div>
        <div class="login-btn text-center">
            <a class="ht-btn style-5" href="/contact">Contact Us</a>
        </div>
    </div>
</div>
<!-- side-bar end -->

<style>
    .account-menu {
        position: relative;
    }

    .account-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.5rem;
        cursor: pointer;
        border: 2px solid #e0e0e0;
        transition: all 0.2s;
    }

    .account-avatar:hover {
        transform: scale(1.05);
        border-color: #c53040;
    }

    .account-avatar-img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        cursor: pointer;
        border: 2px solid #e0e0e0;
        transition: all 0.2s;
    }

    .account-avatar-img:hover {
        transform: scale(1.05);
        border-color: #c53040;
    }

    .account-dropdown {
        position: absolute;
        right: 0;
        top: 100%;
        margin-top: 0.5rem;
        min-width: 280px;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        display: none;
        z-index: 1000;
    }

    .account-dropdown.show {
        display: block;
    }

    .account-dropdown-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e0e0e0;
    }

    .account-dropdown-item {
        display: block;
        padding: 0.75rem 1.5rem;
        color: #333;
        text-decoration: none;
        transition: background 0.2s;
    }

    .account-dropdown-item:hover {
        background: #f8f9fa;
        color: #c53040;
    }

    .account-dropdown-item i {
        width: 20px;
        margin-right: 0.5rem;
    }

    .account-dropdown-divider {
        height: 1px;
        background: #e0e0e0;
        margin: 0.5rem 0;
    }

    .mobile-account-links a {
        color: #333;
        text-decoration: none;
        transition: color 0.2s;
    }

    .mobile-account-links a:hover {
        color: #c53040;
    }
</style>

<script>
    // Account dropdown toggle for public site
    document.getElementById('publicAccountMenuToggle')?.addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('publicAccountDropdown').classList.toggle('show');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        var dropdown = document.getElementById('publicAccountDropdown');
        var toggle = document.getElementById('publicAccountMenuToggle');
        if (dropdown && !dropdown.contains(e.target) && toggle && !toggle.contains(e.target)) {
            dropdown.classList.remove('show');
        }
    });
</script>
