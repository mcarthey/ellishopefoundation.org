@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using EllisHope.Models.Domain
@using EllisHope.Data
@using EllisHope.Services
@using System.Security.Claims
@inject UserManager<ApplicationUser> UserManager
@inject ApplicationDbContext DbContext
@inject IResponsibilityService ResponsibilityService
@{
    string? profilePictureUrl = null;
    int pendingQuotesCount = 0;
    int pendingApplicationsCount = 0;

    // Responsibility flags (default to false, set below if user has them)
    bool canManageBlogs = false;
    bool canManageEvents = false;
    bool canManageCauses = false;
    bool canManageNewsletters = false;
    bool canManageMedia = false;
    bool canReviewSponsors = false;
    bool canManageTestimonials = false;
    bool isAdmin = User.IsInRole("Admin");

    if (User.Identity?.IsAuthenticated == true)
    {
        var currentUser = await UserManager.GetUserAsync(User);
        profilePictureUrl = currentUser?.ProfilePictureUrl;
        var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);

        // Admins have all capabilities
        if (isAdmin)
        {
            canManageBlogs = true;
            canManageEvents = true;
            canManageCauses = true;
            canManageNewsletters = true;
            canManageMedia = true;
            canReviewSponsors = true;
            canManageTestimonials = true;
        }
        else if (!string.IsNullOrEmpty(userId))
        {
            // Check individual responsibilities for non-admin users
            canManageBlogs = await ResponsibilityService.HasResponsibilityAsync(userId, Responsibility.Blogger);
            canManageEvents = await ResponsibilityService.HasResponsibilityAsync(userId, Responsibility.EventPlanner);
            canManageCauses = await ResponsibilityService.HasResponsibilityAsync(userId, Responsibility.CauseManager);
            canManageNewsletters = await ResponsibilityService.HasResponsibilityAsync(userId, Responsibility.NewsletterEditor);
            canManageMedia = await ResponsibilityService.HasAnyResponsibilityAsync(userId,
                Responsibility.MediaManager, Responsibility.Blogger, Responsibility.EventPlanner, Responsibility.CauseManager);
            canReviewSponsors = await ResponsibilityService.HasResponsibilityAsync(userId, Responsibility.SponsorReviewer);
            canManageTestimonials = await ResponsibilityService.HasResponsibilityAsync(userId, Responsibility.TestimonialManager);
        }

        // Get notification counts for admin users or those with relevant responsibilities
        if (isAdmin || User.IsInRole("BoardMember") || User.IsInRole("Editor") || canReviewSponsors)
        {
            pendingQuotesCount = await DbContext.Users
                .CountAsync(u => u.UserRole == UserRole.Sponsor
                    && !string.IsNullOrEmpty(u.SponsorQuote)
                    && u.SponsorQuoteSubmittedDate != null
                    && !u.SponsorQuoteApproved);

            pendingApplicationsCount = await DbContext.ClientApplications
                .CountAsync(a => a.Status == ApplicationStatus.Submitted
                    || a.Status == ApplicationStatus.UnderReview);
        }
    }
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Ellis Hope Foundation Admin</title>
    <link rel="stylesheet" href="~/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/assets/fonts/bootstrap-icons.css" />
    <link rel="stylesheet" href="~/assets/css/admin.css" />
    @await RenderSectionAsync("Styles", required: false)
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            @if (User.Identity?.IsAuthenticated == true)
            {
                <!-- Sidebar -->
                <nav class="col-md-2 d-md-block admin-sidebar p-3">
                    <div class="mb-4">
                        <h4 class="text-white">EHF Portal</h4>
                        <div class="d-flex align-items-center mt-2">
                            @if (!string.IsNullOrEmpty(profilePictureUrl))
                            {
                                <img src="@profilePictureUrl" alt="Profile"
                                     class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover; border: 2px solid rgba(255,255,255,0.3);" />
                            }
                            <small class="text-white-50">@User.Identity.Name</small>
                        </div>
                        @if (User.IsInRole("Admin"))
                        {
                            <span class="badge bg-danger d-block mt-1">Admin</span>
                        }
                        else if (User.IsInRole("BoardMember"))
                        {
                            <span class="badge bg-primary d-block mt-1">Board Member</span>
                        }
                        else if (User.IsInRole("Sponsor"))
                        {
                            <span class="badge bg-success d-block mt-1">Sponsor</span>
                        }
                        else if (User.IsInRole("Client"))
                        {
                            <span class="badge bg-info d-block mt-1">Client</span>
                        }
                        else if (User.IsInRole("Member"))
                        {
                            <span class="badge bg-secondary d-block mt-1">Member</span>
                        }
                    </div>

                    <ul class="nav flex-column">
                        @* Role-specific dashboard links *@
                        @if (User.IsInRole("Admin") || User.IsInRole("Editor"))
                        {
                            <li class="nav-item">
                                <a class="nav-link" asp-area="Admin" asp-controller="Dashboard" asp-action="Index">
                                    <i class="bi bi-speedometer2"></i> Dashboard
                                </a>
                            </li>
                        }
                        @if (User.IsInRole("BoardMember"))
                        {
                            <li class="nav-item">
                                <a class="nav-link" asp-area="Admin" asp-controller="BoardMember" asp-action="Dashboard">
                                    <i class="bi bi-briefcase-fill"></i> Dashboard
                                </a>
                            </li>
                        }
                        @if (User.IsInRole("Sponsor"))
                        {
                            <li class="nav-item">
                                <a class="nav-link" asp-area="Admin" asp-controller="Sponsor" asp-action="Dashboard">
                                    <i class="bi bi-heart-fill"></i> Dashboard
                                </a>
                            </li>
                        }
                        @if (User.IsInRole("Client"))
                        {
                            <li class="nav-item">
                                <a class="nav-link" asp-area="Admin" asp-controller="Client" asp-action="Dashboard">
                                    <i class="bi bi-person-badge"></i> Dashboard
                                </a>
                            </li>
                        }
                        @if (User.IsInRole("Member"))
                        {
                            <li class="nav-item">
                                <a class="nav-link" asp-area="Admin" asp-controller="Member" asp-action="Dashboard">
                                    <i class="bi bi-speedometer2"></i> Dashboard
                                </a>
                            </li>
                        }

                        @* Admin/Board Member/Editor common navigation *@
                        @if (User.IsInRole("Admin") || User.IsInRole("BoardMember") || User.IsInRole("Editor"))
                        {
                            @if (User.IsInRole("Admin"))
                            {
                                <li class="nav-item">
                                    <a class="nav-link" asp-area="Admin" asp-controller="Users" asp-action="Index">
                                        <i class="bi bi-people"></i> Users
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link d-flex justify-content-between align-items-center" asp-area="Admin" asp-controller="Users" asp-action="PendingSponsorQuotes">
                                        <span><i class="bi bi-quote"></i> Pending Quotes</span>
                                        @if (pendingQuotesCount > 0)
                                        {
                                            <span class="badge bg-warning text-dark rounded-pill">@pendingQuotesCount</span>
                                        }
                                    </a>
                                </li>
                            }
                            <li class="nav-item">
                                <a class="nav-link d-flex justify-content-between align-items-center" asp-area="Admin" asp-controller="Applications" asp-action="Index">
                                    <span><i class="bi bi-file-earmark-text"></i> Applications</span>
                                    @if (pendingApplicationsCount > 0)
                                    {
                                        <span class="badge bg-danger rounded-pill">@pendingApplicationsCount</span>
                                    }
                                </a>
                            </li>
                            @* Pages are Admin-only *@
                            @if (isAdmin)
                            {
                                <li class="nav-item">
                                    <a class="nav-link" asp-area="Admin" asp-controller="Pages" asp-action="Index">
                                        <i class="bi bi-file-earmark-text"></i> Pages
                                    </a>
                                </li>
                            }
                            @* Content management - responsibility-based *@
                            @if (canManageBlogs)
                            {
                                <li class="nav-item">
                                    <a class="nav-link" asp-area="Admin" asp-controller="Blog" asp-action="Index">
                                        <i class="bi bi-newspaper"></i> Blog Posts
                                    </a>
                                </li>
                            }
                            @if (canManageEvents)
                            {
                                <li class="nav-item">
                                    <a class="nav-link" asp-area="Admin" asp-controller="Events" asp-action="Index">
                                        <i class="bi bi-calendar-event"></i> Events
                                    </a>
                                </li>
                            }
                            @if (canManageCauses)
                            {
                                <li class="nav-item">
                                    <a class="nav-link" asp-area="Admin" asp-controller="Causes" asp-action="Index">
                                        <i class="bi bi-heart"></i> Causes
                                    </a>
                                </li>
                            }
                            @if (canManageTestimonials)
                            {
                                <li class="nav-item">
                                    <a class="nav-link" asp-area="Admin" asp-controller="Testimonials" asp-action="Index">
                                        <i class="bi bi-chat-quote"></i> Testimonials
                                    </a>
                                </li>
                            }
                            @if (canManageMedia)
                            {
                                <li class="nav-item">
                                    <a class="nav-link" asp-area="Admin" asp-controller="Media" asp-action="Index">
                                        <i class="bi bi-image"></i> Media Library
                                    </a>
                                </li>
                            }
                            @if (canManageNewsletters)
                            {
                                <li class="nav-item">
                                    <a class="nav-link" asp-area="Admin" asp-controller="Newsletter" asp-action="Index">
                                        <i class="bi bi-envelope"></i> Newsletter
                                    </a>
                                </li>
                            }
                            @if (User.IsInRole("Admin"))
                            {
                                <li class="nav-item">
                                    <a class="nav-link" asp-area="Admin" asp-controller="Logs" asp-action="Index">
                                        <i class="bi bi-journal-text"></i> System Logs
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" asp-area="Admin" asp-controller="Settings" asp-action="Index">
                                        <i class="bi bi-gear"></i> Settings
                                    </a>
                                </li>
                            }
                        }

                        @* Client Portal Navigation *@
                        @if (User.IsInRole("Client"))
                        {
                            <li class="nav-item">
                                <a class="nav-link" asp-area="Admin" asp-controller="Client" asp-action="Progress">
                                    <i class="bi bi-graph-up-arrow"></i> My Progress
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" asp-area="Admin" asp-controller="Client" asp-action="Resources">
                                    <i class="bi bi-book"></i> Resources
                                </a>
                            </li>
                        }

                        @* Member Portal Navigation *@
                        @if (User.IsInRole("Member"))
                        {
                            <li class="nav-item">
                                <a class="nav-link" asp-area="" asp-controller="MyApplications" asp-action="Index" target="_blank">
                                    <i class="bi bi-box-arrow-up-right"></i> My Applications
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" asp-area="Admin" asp-controller="Member" asp-action="Events">
                                    <i class="bi bi-calendar-event"></i> Events
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" asp-area="Admin" asp-controller="Member" asp-action="Volunteer">
                                    <i class="bi bi-hand-thumbs-up"></i> Volunteer
                                </a>
                            </li>
                        }

                        @* Common Navigation Items *@
                        <li class="nav-item mt-3">
                            <small class="text-white-50 px-3">Personal</small>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" asp-area="Admin" asp-controller="Profile" asp-action="Index">
                                <i class="bi bi-person-circle"></i> My Profile
                            </a>
                        </li>
                    </ul>
                </nav>

                <!-- Main Content -->
                <main class="col-md-10 ms-sm-auto">
                    <div class="admin-header d-flex justify-content-between align-items-center">
                        <h2>@ViewData["Title"]</h2>
                        <div class="d-flex align-items-center gap-3">
                            <a href="/" target="_blank" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-box-arrow-up-right"></i> View Site
                            </a>
                            
                            <!-- Account Menu -->
                            <div class="account-menu">
                                @if (!string.IsNullOrEmpty(profilePictureUrl))
                                {
                                    <img src="@profilePictureUrl" alt="Profile" id="accountMenuToggle"
                                         class="account-avatar-img" title="@User.Identity?.Name"
                                         style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; border: 2px solid #e0e0e0;" />
                                }
                                else
                                {
                                    <div class="account-avatar" id="accountMenuToggle">
                                        @{
                                            var initial = User.Identity?.Name?.Substring(0, 1).ToUpper() ?? "?";
                                        }
                                        @initial
                                    </div>
                                }
                                <div class="account-dropdown" id="accountDropdown">
                                    <div class="account-dropdown-header">
                                        <div class="fw-bold">@User.Identity?.Name</div>
                                        <small class="text-muted">
                                            @if (User.IsInRole("Admin"))
                                            {
                                                <span class="badge bg-danger">Admin</span>
                                            }
                                            else if (User.IsInRole("BoardMember"))
                                            {
                                                <span class="badge bg-primary">Board Member</span>
                                            }
                                            else if (User.IsInRole("Sponsor"))
                                            {
                                                <span class="badge bg-success">Sponsor</span>
                                            }
                                            else if (User.IsInRole("Client"))
                                            {
                                                <span class="badge bg-info">Client</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Member</span>
                                            }
                                        </small>
                                    </div>
                                    <a asp-area="Admin" asp-controller="Profile" asp-action="Index" class="account-dropdown-item">
                                        <i class="bi bi-person-circle"></i> My Profile
                                    </a>
                                    <a asp-area="Admin" asp-controller="Profile" asp-action="Edit" class="account-dropdown-item">
                                        <i class="bi bi-pencil-square"></i> Edit Profile
                                    </a>
                                    <a asp-area="Admin" asp-controller="Profile" asp-action="ChangePassword" class="account-dropdown-item">
                                        <i class="bi bi-key"></i> Change Password
                                    </a>
                                    @* Quick access to Applications for Admin/BoardMember/Editor *@
                                    @if (User.IsInRole("Admin") || User.IsInRole("BoardMember") || User.IsInRole("Editor"))
                                    {
                                        <div class="account-dropdown-divider"></div>
                                        <a asp-area="Admin" asp-controller="Applications" asp-action="Index" class="account-dropdown-item">
                                            <i class="bi bi-file-earmark-text"></i> Applications
                                        </a>
                                    }
                                    <div class="account-dropdown-divider"></div>
                                    <form asp-area="Admin" asp-controller="Account" asp-action="Logout" method="post" class="m-0" asp-antiforgery="true">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="account-dropdown-item border-0 bg-transparent text-start w-100">
                                            <i class="bi bi-box-arrow-right"></i> Sign Out
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="admin-content">
                        @RenderBody()
                    </div>
                </main>
            }
            else
            {
                <div class="col-12">
                    @RenderBody()
                </div>
            }
        </div>
    </div>

    <script src="~/assets/js/jquery-3.5.1.min.js"></script>
    <script src="~/assets/js/bootstrap.bundle.min.js"></script>
    <script>
        // Account dropdown toggle
        document.getElementById('accountMenuToggle')?.addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('accountDropdown').classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            var dropdown = document.getElementById('accountDropdown');
            var toggle = document.getElementById('accountMenuToggle');
            if (dropdown && !dropdown.contains(e.target) && !toggle.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });
    </script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
