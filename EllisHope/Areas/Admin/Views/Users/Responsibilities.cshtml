@model EllisHope.Areas.Admin.Models.EditResponsibilitiesViewModel
@{
    ViewData["Title"] = $"Responsibilities - {Model.UserName}";
}

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>
                    <i class="bi bi-shield-check"></i> Edit Responsibilities
                </h2>
                <p class="text-muted">@Model.UserName - @Model.Email</p>
            </div>
            <div class="btn-group">
                <a asp-action="Edit" asp-route-id="@Model.UserId" class="btn btn-primary">
                    <i class="bi bi-pencil"></i> Edit User
                </a>
                <a asp-action="Details" asp-route-id="@Model.UserId" class="btn btn-info">
                    <i class="bi bi-eye"></i> View Details
                </a>
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to List
                </a>
            </div>
        </div>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-person-badge"></i> User Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Name:</strong> @Model.UserName
                    </div>
                    <div class="col-md-6">
                        <strong>Role:</strong>
                        <span class="badge @GetRoleBadgeClass(Model.UserRole)">@Model.UserRole</span>
                    </div>
                </div>
                <p class="text-muted small mt-2 mb-0">
                    <i class="bi bi-info-circle"></i>
                    Responsibilities allow users to manage specific content areas. Admins always have access to all areas.
                </p>
            </div>
        </div>

        <form asp-action="Responsibilities" asp-route-id="@Model.UserId" method="post">
            <input type="hidden" asp-for="UserId" />
            <input type="hidden" asp-for="UserName" />
            <input type="hidden" asp-for="Email" />
            <input type="hidden" asp-for="UserRole" />

            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-list-check"></i> Assigned Responsibilities
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        Select the content areas this user can manage. Enable "Auto-Approve" to allow content to be published immediately without admin review.
                    </p>

                    @for (int i = 0; i < Model.Responsibilities.Count; i++)
                    {
                        var item = Model.Responsibilities[i];
                        <input type="hidden" name="Responsibilities[@i].Responsibility" value="@item.Responsibility" />
                        <input type="hidden" name="Responsibilities[@i].Name" value="@item.Name" />
                        <input type="hidden" name="Responsibilities[@i].Description" value="@item.Description" />

                        <div class="border rounded p-3 mb-3 @(item.IsAssigned ? "bg-light border-success" : "")">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input responsibility-checkbox"
                                               type="checkbox"
                                               name="Responsibilities[@i].IsAssigned"
                                               value="true"
                                               id="resp_@i"
                                               @(item.IsAssigned ? "checked" : "")
                                               data-index="@i">
                                        <label class="form-check-label fw-bold" for="resp_@i">
                                            <i class="bi @GetResponsibilityIcon(item.Responsibility)"></i>
                                            @item.Name
                                        </label>
                                    </div>
                                    <p class="text-muted small mb-0 ms-4">@item.Description</p>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch auto-approve-container" id="autoApproveContainer_@i" style="@(item.IsAssigned ? "" : "opacity: 0.5;")">
                                        <input class="form-check-input auto-approve-checkbox"
                                               type="checkbox"
                                               name="Responsibilities[@i].AutoApprove"
                                               value="true"
                                               id="autoApprove_@i"
                                               @(item.AutoApprove ? "checked" : "")
                                               @(item.IsAssigned ? "" : "disabled")>
                                        <label class="form-check-label" for="autoApprove_@i">
                                            <i class="bi bi-lightning-charge"></i> Auto-Approve
                                            <span class="badge bg-warning text-dark">Instant Publish</span>
                                        </label>
                                    </div>
                                    <p class="text-muted small mb-0">
                                        @if (item.AutoApprove)
                                        {
                                            <span class="text-success"><i class="bi bi-check-circle"></i> Content publishes immediately</span>
                                        }
                                        else
                                        {
                                            <span><i class="bi bi-hourglass-split"></i> Content requires admin approval</span>
                                        }
                                    </p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="card-footer">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-save"></i> Save Responsibilities
                    </button>
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="bi bi-x"></i> Cancel
                    </a>
                </div>
            </div>
        </form>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-question-circle"></i> About Responsibilities
                </h5>
            </div>
            <div class="card-body">
                <h6><i class="bi bi-shield-check"></i> What are Responsibilities?</h6>
                <p class="small">
                    Responsibilities grant users permission to manage specific content areas without needing full admin access.
                </p>

                <h6><i class="bi bi-lightning-charge"></i> Auto-Approve</h6>
                <p class="small">
                    When enabled, content created by this user is published immediately. When disabled, content goes to a pending queue for admin review.
                </p>

                <h6><i class="bi bi-person-gear"></i> Admin Override</h6>
                <p class="small mb-0">
                    Administrators always have access to all content areas regardless of assigned responsibilities.
                </p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Toggle auto-approve when responsibility checkbox changes
            document.querySelectorAll('.responsibility-checkbox').forEach(function (checkbox) {
                checkbox.addEventListener('change', function () {
                    var index = this.dataset.index;
                    var container = document.getElementById('autoApproveContainer_' + index);
                    var autoApproveCheckbox = document.getElementById('autoApprove_' + index);

                    if (this.checked) {
                        container.style.opacity = '1';
                        autoApproveCheckbox.disabled = false;
                    } else {
                        container.style.opacity = '0.5';
                        autoApproveCheckbox.disabled = true;
                        autoApproveCheckbox.checked = false;
                    }

                    // Update parent border
                    var parentDiv = this.closest('.border');
                    if (this.checked) {
                        parentDiv.classList.add('bg-light', 'border-success');
                    } else {
                        parentDiv.classList.remove('bg-light', 'border-success');
                    }
                });
            });
        });
    </script>
}

@functions {
    string GetRoleBadgeClass(EllisHope.Models.Domain.UserRole role)
    {
        return role switch
        {
            EllisHope.Models.Domain.UserRole.Admin => "bg-danger",
            EllisHope.Models.Domain.UserRole.BoardMember => "bg-primary",
            EllisHope.Models.Domain.UserRole.Sponsor => "bg-success",
            EllisHope.Models.Domain.UserRole.Client => "bg-info",
            EllisHope.Models.Domain.UserRole.Member => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    string GetResponsibilityIcon(EllisHope.Models.Domain.Responsibility responsibility)
    {
        return responsibility switch
        {
            EllisHope.Models.Domain.Responsibility.Blogger => "bi-pencil-square",
            EllisHope.Models.Domain.Responsibility.EventPlanner => "bi-calendar-event",
            EllisHope.Models.Domain.Responsibility.CauseManager => "bi-heart",
            EllisHope.Models.Domain.Responsibility.NewsletterEditor => "bi-envelope",
            EllisHope.Models.Domain.Responsibility.SponsorReviewer => "bi-chat-quote",
            EllisHope.Models.Domain.Responsibility.MediaManager => "bi-images",
            _ => "bi-check"
        };
    }
}
