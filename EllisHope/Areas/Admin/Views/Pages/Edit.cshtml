@model EllisHope.Models.Domain.PageTemplate
@{
    ViewData["Title"] = $"Edit {Model.DisplayName}";
    var availableMedia = ViewBag.AvailableMedia as IEnumerable<EllisHope.Models.Domain.Media> ?? Enumerable.Empty<EllisHope.Models.Domain.Media>();
    var pageId = (int)ViewBag.PageId;
    var pageName = (string)ViewBag.PageName;
}

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>
                    <i class="bi bi-pencil-square"></i> @Model.DisplayName
                </h2>
                <p class="text-muted">@Model.Description</p>
            </div>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Pages
            </a>
        </div>

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <!-- Info Alert about Template vs Managed -->
        <div class="alert alert-info mb-4">
            <h6 class="alert-heading"><i class="bi bi-info-circle"></i> How This Works</h6>
            <p class="mb-2">Each image and text field shows:</p>
            <ul class="mb-0">
                <li><span class="badge bg-success">Managed</span> - You've customized this content (stored in database)</li>
                <li><span class="badge bg-warning text-dark">Template</span> - Using default from website design (not yet customized)</li>
            </ul>
            <p class="mt-2 mb-0"><strong>To customize:</strong> Select a new image or edit the text and click Save/Update</p>
        </div>

        <!-- Images Section -->
        @if (Model.Images.Any())
        {
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-images"></i> Images
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        @foreach (var image in Model.Images)
                        {
                            <div class="col-md-6 col-lg-4">
                                <div class="card h-100 shadow-sm @(image.IsManagedImage ? "border-success" : "border-warning")">
                                    <div class="card-header @(image.IsManagedImage ? "bg-success" : "bg-warning") bg-opacity-10">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0 fw-bold">@image.Label</h6>
                                            <span class="badge @(image.IsManagedImage ? "bg-success" : "bg-warning text-dark")">
                                                @image.ImageSource
                                            </span>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text small text-muted mb-2">@image.Description</p>
                                        
                                        <!-- Size Requirements -->
                                        <div class="alert alert-light border mb-3 py-2 px-2">
                                            <small class="d-block fw-bold mb-1">
                                                <i class="bi bi-rulers"></i> Size Requirements:
                                            </small>
                                            <ul class="mb-0 small ps-3">
                                                <li><strong>Recommended:</strong> @image.Requirements.DisplayText</li>
                                                <li><strong>Aspect Ratio:</strong> @image.Requirements.AspectRatio (@image.Requirements.Orientation)</li>
                                                @if (image.Requirements.MinWidth.HasValue)
                                                {
                                                    <li><strong>Min:</strong> @(image.Requirements.MinWidth)×@(image.Requirements.MinHeight)px</li>
                                                }
                                                <li><strong>Max File Size:</strong> @((image.Requirements.MaxFileSizeBytes / 1024 / 1024))MB</li>
                                            </ul>
                                        </div>
                                        
                                        <!-- Current Image Preview -->
                                        <div class="mb-3">
                                            <img src="@image.EffectiveImagePath" 
                                                 alt="@image.Label" 
                                                 class="img-fluid rounded mb-2" 
                                                 style="max-height: 200px; width: 100%; object-fit: cover;"
                                                 id="preview-@image.Key" />
                                            <small class="text-muted d-block">
                                                @if (image.IsManagedImage)
                                                {
                                                    <i class="bi bi-check-circle text-success"></i> <text>Customized via Media Library</text>
                                                }
                                                else if (!string.IsNullOrEmpty(image.CurrentTemplatePath))
                                                {
                                                    <i class="bi bi-exclamation-triangle text-warning"></i> <text>Using template default</text>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-x-circle text-danger"></i> <text>No image set</text>
                                                }
                                            </small>
                                        </div>

                                        <!-- Image Selection Form -->
                                        <form asp-action="UpdateImage" method="post" onsubmit="return validateImageSelection('@image.Key')">
                                            <input type="hidden" name="pageId" value="@pageId" />
                                            <input type="hidden" name="imageKey" value="@image.Key" />
                                            
                                            <div class="mb-2">
                                                <label class="form-label small fw-bold">Select Image:</label>
                                                <select name="mediaId" 
                                                        class="form-select form-select-sm image-select" 
                                                        id="select-@image.Key"
                                                        data-requirements='@System.Text.Json.JsonSerializer.Serialize(image.Requirements)'
                                                        onchange="previewImageFromSelect(this, '@image.Key')"
                                                        required>
                                                    <option value="">-- Choose from Media Library --</option>
                                                    @foreach (var media in availableMedia.Where(m => m.MimeType.StartsWith("image/")))
                                                    {
                                                        var sizeInfo = $"{media.Width}×{media.Height}px, {(media.FileSize / 1024 / 1024):F2}MB";
                                                        <option value="@media.Id" 
                                                                data-width="@media.Width"
                                                                data-height="@media.Height"
                                                                data-filesize="@media.FileSize"
                                                                data-path="@media.FilePath"
                                                                selected="@(media.Id == image.CurrentMediaId)">
                                                            @media.FileName - [@sizeInfo]
                                                        </option>
                                                    }
                                                </select>
                                                <div id="warning-@image.Key" class="mt-1"></div>
                                            </div>
                                            
                                            <div class="d-flex gap-2">
                                                <button type="submit" class="btn btn-sm btn-primary flex-fill">
                                                    <i class="bi bi-check-lg"></i> Update
                                                </button>
                                                @if (image.IsManagedImage)
                                                {
                                                    <button type="button" 
                                                            class="btn btn-sm btn-outline-warning" 
                                                            onclick="removeImage('@pageId', '@image.Key', '@image.Label')"
                                                            title="Revert to template default">
                                                        <i class="bi bi-arrow-counterclockwise"></i>
                                                    </button>
                                                }
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    
                    <div class="alert alert-light border mt-4 mb-0">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-lightbulb text-warning fs-4 me-2"></i>
                            <div>
                                <strong>Need images?</strong>
                                <ul class="mb-0 mt-1">
                                    <li>Upload your own: <a asp-area="Admin" asp-controller="Media" asp-action="Upload" class="fw-bold">Upload Images</a></li>
                                    <li>Use free stock photos: <a asp-area="Admin" asp-controller="Media" asp-action="UnsplashSearch" class="fw-bold">Browse Unsplash</a></li>
                                    <li>View all: <a asp-area="Admin" asp-controller="Media" asp-action="Index" class="fw-bold">Media Library</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Content Areas Section -->
        @if (Model.ContentAreas.Any())
        {
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-file-text"></i> Content
                    </h5>
                </div>
                <div class="card-body">
                    @foreach (var content in Model.ContentAreas)
                    {
                        <div class="card mb-3 shadow-sm @(content.IsManagedContent ? "border-success" : "border-warning")">
                            <div class="card-header @(content.IsManagedContent ? "bg-success" : "bg-warning") bg-opacity-10">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0 fw-bold">@content.Label</h6>
                                    <span class="badge @(content.IsManagedContent ? "bg-success" : "bg-warning text-dark")">
                                        @content.ContentSource
                                    </span>
                                </div>
                            </div>
                            <div class="card-body">
                                <p class="card-text small text-muted mb-1">@content.Description</p>
                                @if (!content.IsManagedContent && !string.IsNullOrEmpty(content.CurrentTemplateValue))
                                {
                                    <p class="small text-warning mb-3">
                                        <i class="bi bi-exclamation-triangle"></i> Currently using template default - edit below to customize
                                    </p>
                                }
                                
                                <form asp-action="UpdateContent" method="post">
                                    <input type="hidden" name="pageId" value="@pageId" />
                                    <input type="hidden" name="sectionKey" value="@content.Key" />
                                    <input type="hidden" name="contentType" value="@content.ContentType" />
                                    
                                    <div class="mb-3">
                                        @if (content.ContentType == "RichText")
                                        {
                                            <textarea name="content" 
                                                      class="form-control tinymce-editor" 
                                                      rows="8">@(content.EffectiveContent)</textarea>
                                        }
                                        else if (content.ContentType == "Text")
                                        {
                                            if (content.MaxLength > 200)
                                            {
                                                <textarea name="content" 
                                                          class="form-control" 
                                                          rows="4" 
                                                          maxlength="@content.MaxLength"
                                                          placeholder="Enter @content.Label.ToLower()...">@(content.EffectiveContent)</textarea>
                                                @if (content.MaxLength > 0)
                                                {
                                                    <small class="text-muted">Maximum @content.MaxLength characters</small>
                                                }
                                            }
                                            else
                                            {
                                                <input type="text" 
                                                       name="content" 
                                                       class="form-control" 
                                                       value="@content.EffectiveContent" 
                                                       maxlength="@content.MaxLength"
                                                       placeholder="Enter @content.Label.ToLower()..." />
                                                @if (content.MaxLength > 0)
                                                {
                                                    <small class="text-muted">Maximum @content.MaxLength characters</small>
                                                }
                                            }
                                        }
                                        else
                                        {
                                            <textarea name="content" 
                                                      class="form-control font-monospace" 
                                                      rows="6" 
                                                      placeholder="Enter HTML...">@(content.EffectiveContent)</textarea>
                                            <small class="text-muted">Raw HTML - for advanced users only</small>
                                        }
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save"></i> Save @content.Label
                                    </button>
                                </form>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Help Card -->
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="bi bi-question-circle"></i> Understanding Template vs Managed Content
                </h6>
            </div>
            <div class="card-body">
                <h6><span class="badge bg-warning text-dark">Template</span> Content</h6>
                <ul>
                    <li>Default content from the website design</li>
                    <li>Files stored in <code>/wwwroot/assets/img/</code></li>
                    <li><strong>Not managed</strong> in Media Library</li>
                    <li>To customize: Select a new image from Media Library and click Update</li>
                </ul>
                
                <h6 class="mt-3"><span class="badge bg-success">Managed</span> Content</h6>
                <ul>
                    <li>Content you've customized</li>
                    <li>Images stored in <code>/wwwroot/uploads/media/</code></li>
                    <li><strong>Managed</strong> in Media Library</li>
                    <li>Can be reverted to template default by clicking "Revert"
                </ul>
                
                <h6 class="mt-3">Tips</h6>
                <ul class="mb-0">
                    <li><strong>Start simple:</strong> Change one image or text field at a time</li>
                    <li><strong>Preview:</strong> View the live site to see your changes</li>
                    <li><strong>Revert:</strong> Click "Revert" to go back to template default</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Hidden form for removing images -->
<form id="removeImageForm" asp-action="RemoveImage" method="post" style="display:none;">
    <input type="hidden" id="removePageId" name="pageId" />
    <input type="hidden" id="removeImageKey" name="imageKey" />
</form>

@section Scripts {
    <script src="https://cdn.tiny.cloud/1/@ViewData["TinyMceApiKey"]/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
    <script>
        // Initialize TinyMCE for rich text areas
        tinymce.init({
            selector: 'textarea.tinymce-editor',
            height: 300,
            menubar: false,
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'help', 'wordcount'
            ],
            toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | bullist numlist | link image | removeformat | help',
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; }'
        });

        function removeImage(pageId, imageKey, imageLabel) {
            if (confirm(`Revert "${imageLabel}" to template default?\n\nThis will remove your custom image and use the original template image.`)) {
                document.getElementById('removePageId').value = pageId;
                document.getElementById('removeImageKey').value = imageKey;
                document.getElementById('removeImageForm').submit();
            }
        }

        // Image validation and preview
        function previewImageFromSelect(selectElement, imageKey) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const imagePath = selectedOption.dataset.path;
            const warningDiv = document.getElementById(`warning-${imageKey}`);
            const previewImg = document.getElementById(`preview-${imageKey}`);
            
            if (!imagePath) {
                warningDiv.innerHTML = '';
                return;
            }
            
            // Update preview
            previewImg.src = imagePath;
            
            // Get requirements
            const requirementsJson = selectElement.dataset.requirements;
            if (!requirementsJson) return;
            
            const requirements = JSON.parse(requirementsJson);
            const width = parseInt(selectedOption.dataset.width) || 0;
            const height = parseInt(selectedOption.dataset.height) || 0;
            const fileSize = parseInt(selectedOption.dataset.filesize) || 0;
            
            // Validate
            const warnings = [];
            const errors = [];
            
            // File size check
            if (fileSize > requirements.MaxFileSizeBytes) {
                errors.push(`File too large: ${(fileSize/1024/1024).toFixed(2)}MB (max: ${(requirements.MaxFileSizeBytes/1024/1024)}MB)`);
            }
            
            // Dimension checks
            if (requirements.MinWidth && width < requirements.MinWidth) {
                errors.push(`Width too small: ${width}px (min: ${requirements.MinWidth}px)`);
            }
            if (requirements.MaxWidth && width > requirements.MaxWidth) {
                warnings.push(`Width very large: ${width}px (recommended max: ${requirements.MaxWidth}px)`);
            }
            if (requirements.MinHeight && height < requirements.MinHeight) {
                errors.push(`Height too small: ${height}px (min: ${requirements.MinHeight}px)`);
            }
            if (requirements.MaxHeight && height > requirements.MaxHeight) {
                warnings.push(`Height very large: ${height}px (recommended max: ${requirements.MaxHeight}px)`);
            }
            
            // Aspect ratio check (within 10% tolerance)
            if (width > 0 && height > 0) {
                const actualRatio = width / height;
                const expectedRatio = parseFloat(requirements.AspectRatioDecimal);
                
                if (expectedRatio && Math.abs(actualRatio - expectedRatio) > expectedRatio * 0.15) {
                    warnings.push(`Aspect ratio mismatch: ${width}×${height} = ${actualRatio.toFixed(2)}:1 (expected ${requirements.AspectRatio})`);
                }
            }
            
            // Orientation check
            if (requirements.Orientation === 'Landscape' && width < height) {
                warnings.push(`Portrait image selected but landscape expected`);
            } else if (requirements.Orientation === 'Portrait' && width > height) {
                warnings.push(`Landscape image selected but portrait expected`);
            } else if (requirements.Orientation === 'Square' && width !== height) {
                warnings.push(`Non-square image selected but square expected`);
            }
            
            // Display warnings/errors
            if (errors.length > 0) {
                warningDiv.innerHTML = `
                    <div class="alert alert-danger alert-sm py-1 px-2 mb-0">
                        <small><i class="bi bi-exclamation-circle"></i> <strong>Image Issues:</strong></small>
                        <ul class="mb-0 small ps-3">
                            ${errors.map(e => `<li>${e}</li>`).join('')}
                        </ul>
                    </div>`;
            } else if (warnings.length > 0) {
                warningDiv.innerHTML = `
                    <div class="alert alert-warning alert-sm py-1 px-2 mb-0">
                        <small><i class="bi bi-exclamation-triangle"></i> <strong>Warnings:</strong></small>
                        <ul class="mb-0 small ps-3">
                            ${warnings.map(w => `<li>${w}</li>`).join('')}
                        </ul>
                    </div>`;
            } else {
                warningDiv.innerHTML = `
                    <div class="alert alert-success alert-sm py-1 px-2 mb-0">
                        <small><i class="bi bi-check-circle"></i> Image meets requirements (${width}×${height}px)</small>
                    </div>`;
            }
        }

        function validateImageSelection(imageKey) {
            const warningDiv = document.getElementById(`warning-${imageKey}`);
            const hasErrors = warningDiv.querySelector('.alert-danger');
            
            if (hasErrors) {
                return confirm('The selected image has size issues. Do you want to use it anyway?\n\nFor best results, please upload an image that meets the requirements.');
            }
            
            return true;
        }

        // Initialize validation on page load for pre-selected images
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.image-select').forEach(select => {
                if (select.value) {
                    const imageKey = select.id.replace('select-', '');
                    previewImageFromSelect(select, imageKey);
                }
            });
        });
    </script>
}
