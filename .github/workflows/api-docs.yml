name: Controller Documentation

on:
  push:
    paths:
      - 'EllisHope/**'
      - 'docs/**'
      - '.github/workflows/api-docs.yml'
  pull_request:
    paths:
      - 'EllisHope/**'
      - 'docs/**'
      - '.github/workflows/api-docs.yml'

jobs:
  generate-controller-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Build solution (with XML docs)
        run: dotnet build EllisHope.sln --configuration Release /p:GenerateDocumentationFile=true

      - name: Generate Controller Documentation
        run: |
          mkdir -p docs

          echo "# Controller Reference" > docs/CONTROLLER_REFERENCE.md
          echo "" >> docs/CONTROLLER_REFERENCE.md
          echo "Auto-generated documentation for all MVC controllers in the Ellis Hope Foundation application." >> docs/CONTROLLER_REFERENCE.md
          echo "" >> docs/CONTROLLER_REFERENCE.md
          echo "Generated on: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> docs/CONTROLLER_REFERENCE.md
          echo "" >> docs/CONTROLLER_REFERENCE.md

          # Public Controllers
          echo "## Public Controllers" >> docs/CONTROLLER_REFERENCE.md
          echo "" >> docs/CONTROLLER_REFERENCE.md

          for file in EllisHope/Controllers/*.cs; do
            if [ -f "$file" ]; then
              name=$(basename "$file" .cs)
              echo "### $name" >> docs/CONTROLLER_REFERENCE.md
              echo "" >> docs/CONTROLLER_REFERENCE.md
              echo "**File:** \`Controllers/$name.cs\`" >> docs/CONTROLLER_REFERENCE.md
              echo "" >> docs/CONTROLLER_REFERENCE.md

              # Extract summary comments from the file
              grep -A1 "/// <summary>" "$file" | grep "///" | sed 's/.*\/\/\/ /- /' | head -20 >> docs/CONTROLLER_REFERENCE.md
              echo "" >> docs/CONTROLLER_REFERENCE.md
            fi
          done

          # Admin Controllers
          echo "## Admin Controllers" >> docs/CONTROLLER_REFERENCE.md
          echo "" >> docs/CONTROLLER_REFERENCE.md

          for file in EllisHope/Areas/Admin/Controllers/*.cs; do
            if [ -f "$file" ]; then
              name=$(basename "$file" .cs)
              echo "### $name" >> docs/CONTROLLER_REFERENCE.md
              echo "" >> docs/CONTROLLER_REFERENCE.md
              echo "**File:** \`Areas/Admin/Controllers/$name.cs\`" >> docs/CONTROLLER_REFERENCE.md
              echo "" >> docs/CONTROLLER_REFERENCE.md

              # Extract Authorize attribute roles
              roles=$(grep -o 'Authorize(Roles = "[^"]*"' "$file" | head -1 | sed 's/Authorize(Roles = "/Roles: /' | sed 's/"$//')
              if [ -n "$roles" ]; then
                echo "**$roles**" >> docs/CONTROLLER_REFERENCE.md
                echo "" >> docs/CONTROLLER_REFERENCE.md
              fi

              # Extract summary comments from the file
              grep -A1 "/// <summary>" "$file" | grep "///" | sed 's/.*\/\/\/ /- /' | head -20 >> docs/CONTROLLER_REFERENCE.md
              echo "" >> docs/CONTROLLER_REFERENCE.md
            fi
          done

          echo "---" >> docs/CONTROLLER_REFERENCE.md
          echo "*This documentation is auto-generated from XML comments in the source code.*" >> docs/CONTROLLER_REFERENCE.md

      - name: Upload Controller Documentation
        uses: actions/upload-artifact@v4
        with:
          name: controller-docs
          path: docs/CONTROLLER_REFERENCE.md
